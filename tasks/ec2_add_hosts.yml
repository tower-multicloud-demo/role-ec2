- name: Add hosts to in-memory inventory
  add_host:
    name: "{{ item.public_ip }}"
    groups: webservers
  with_items: "{{ ec2.instances }}"

- name: Wait for SSH to come up
  wait_for_connection:
    timeout: 600
    sleep: 15
  delegate_to: "{{ item }}"
  with_items: "{{ ips_to_add }}"
